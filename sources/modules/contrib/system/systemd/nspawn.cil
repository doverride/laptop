(roleattribute nspawn_role)

(typeattribute nspawn_admin_subject_type)

(typeattribute nspawn_object_type)

(typeattribute nspawn_common_container_subject_type)
(typeattribute nspawn_common_container_object_type)

(type nspawn_t)
(type nspawn_exec_t)
(call systemd_daemon (nspawn_t nspawn_exec_t))
(call applications_app (nspawn_t nspawn_exec_t))
(roletype nspawn_role nspawn_t)

(roleattributeset nspawn_role system_r)

(context nspawn_exec (system_u object_r nspawn_exec_t (systemlow systemlow)))
(filecon "/usr/bin/systemd-nspawn" file nspawn_exec)

(type nspawn_unit_t)
(call systemd_unit_object_type (nspawn_unit_t))

(typeattributeset nspawn_object_type nspawn_unit_t)

(context nspawn_unit (system_u object_r nspawn_unit_t (systemlow systemlow)))
(filecon "/usr/lib/systemd/system/[^/]*systemd-nspawn.*" file nspawn_unit)

(type nspawn_systemd_runtime_t)
(call systemd_runtime_object_type (nspawn_systemd_runtime_t))

(typeattributeset nspawn_object_type nspawn_systemd_runtime_t)

(context nspawn_systemd_runtime (system_u object_r nspawn_systemd_runtime_t (systemlow systemlow)))
(filecon "/var/run/systemd/nspawn(/.*)?" any nspawn_systemd_runtime)

(allow nspawn_t nspawn_systemd_runtime_t manage_dir_perms)
(allow nspawn_t nspawn_systemd_runtime_t manage_file_perms)
(allow nspawn_t nspawn_systemd_runtime_t manage_lnk_file_perms)
(call nspawn_systemd_runtime_object_type_transition_runtime_dirs (nspawn_t))

(type nspawn_pty_dev_t)
(call terminals_pty_object_type (nspawn_pty_dev_t))

(type mycontainer_subject_t)
(call subject_common_type (nspawn_common_container_subject_type))
(roletype nspawn_role mycontainer_subject_t)

(type mycontainer_object_t)
(call filesystems_object_type (nspawn_common_container_object_type))

(allow nspawn_common_container_subject_type self
    all_process_perms_except_transition_ptrace_setsched_dyntransition_setcurrent_execmem_execstack_and_execheap)
(allow nspawn_common_container_subject_type self rw_file_perms)
(allow nspawn_common_container_subject_type self list_dir_perms)
(allow nspawn_common_container_subject_type self read_lnk_file_perms)
(allow nspawn_common_container_subject_type self (fd (all)))
(allow nspawn_common_container_subject_type self (socket (all)))
(allow nspawn_common_container_subject_type self create_tcp_stream_socket_perms)
(allow nspawn_common_container_subject_type self create_udp_socket_perms)
(allow nspawn_common_container_subject_type self create_rawip_socket_perms)
(allow nspawn_common_container_subject_type self (netlink_socket (all)))
(allow nspawn_common_container_subject_type self (packet_socket (all)))
(allow nspawn_common_container_subject_type self (unix_stream_socket (all)))
(allow nspawn_common_container_subject_type self (unix_dgram_socket (all)))
(allow nspawn_common_container_subject_type self (sem (all)))
(allow nspawn_common_container_subject_type self (msg (all)))
(allow nspawn_common_container_subject_type self (msgq (all)))
(allow nspawn_common_container_subject_type self (shm (all)))
(allow nspawn_common_container_subject_type self (ipc (all)))
(allow nspawn_common_container_subject_type self (netlink_route_socket (all)))
(allow nspawn_common_container_subject_type self (netlink_firewall_socket (all)))
(allow nspawn_common_container_subject_type self (netlink_tcpdiag_socket (all)))
(allow nspawn_common_container_subject_type self (netlink_nflog_socket (all)))
(allow nspawn_common_container_subject_type self (netlink_xfrm_socket (all)))
(allow nspawn_common_container_subject_type self (netlink_selinux_socket (all)))
(allow nspawn_common_container_subject_type self (netlink_audit_socket (all)))
(allow nspawn_common_container_subject_type self (netlink_ip6fw_socket (all)))
(allow nspawn_common_container_subject_type self (netlink_dnrt_socket (all)))
(allow nspawn_common_container_subject_type self (netlink_kobject_uevent_socket (all)))
(allow nspawn_common_container_subject_type self (appletalk_socket (all)))
(allow nspawn_common_container_subject_type self (key (all)))
(allow nspawn_common_container_subject_type self create_dccp_stream_socket_perms)
(allow nspawn_common_container_subject_type self (tun_socket (all)))

(allow nspawn_common_container_subject_type self
    all_capability_perms_except_sys_module_and_sys_nice)
(allow nspawn_common_container_subject_type self
    all_capability2_perms_except_mac_override_and_mac_admin)
(allow nspawn_common_container_subject_type self (process
    (transition dyntransition setcurrent)))
(allow nspawn_common_container_subject_type self
    all_fifo_file_perms_except_mounton_and_execmod)

(call system_unconfined_subject_type (nspawn_common_container_subject_type))

(call files_rootfs_object_type_transition_file (nspawn_common_container_subject_type))
(call files_unconfined_subject_type (nspawn_common_container_subject_type))

(call filesystems_list_sysfs (nspawn_common_container_subject_type))
(call filesystems_rw_sysfs_files (nspawn_common_container_subject_type))
(call filesystems_read_sysfs_lnk_files (nspawn_common_container_subject_type))

(call filesystems_getattr_filesystems (nspawn_common_container_subject_type))
(call filesystems_list_proc (nspawn_common_container_subject_type))

(call subject_dynamic_subject_type_transition_subject_type (nspawn_common_container_subject_type))

(call subject_execheap (nspawn_common_container_subject_type))
(call subject_execmem (nspawn_common_container_subject_type))
(call subject_execstack (nspawn_common_container_subject_type))
(call subject_mmap_low (nspawn_common_container_subject_type))

(call subject_object_identity_change_exemption (nspawn_common_container_subject_type))

(call commands_mprot_read_shell_exec_files (nspawn_common_container_subject_type))
(call commands_shell_exec_object_entry_subject (nspawn_common_container_subject_type))

(call nspawn_use_terminals (nspawn_common_container_subject_type))

(call rpm_run (nspawn_common_container_subject_type nspawn_role))

(call usersubject_common_login_user_home_template (nspawn_common_container_subject_type))
(call usersubject_common_login_user_tmp_template (nspawn_common_container_subject_type))
(call usersubject_common_login_user_tmpfs_template (nspawn_common_container_subject_type))

(allow nspawn_t nspawn_common_container_subject_type (process (sigkill)))

(allow nspawn_t nspawn_common_container_object_type (dir (mounton relabelfrom relabelto
    create open getattr setattr read write link unlink rename search add_name remove_name reparent
    rmdir lock ioctl)))
(allow nspawn_t nspawn_common_container_object_type manage_file_perms)
(allow nspawn_t nspawn_common_container_object_type manage_lnk_file_perms)
(allow nspawn_t nspawn_common_container_object_type manage_fifo_file_perms)

(allow nspawn_t nspawn_common_container_object_type (chr_file (mounton)))
(allow nspawn_t nspawn_common_container_object_type create_chr_file_perms)

(allow nspawn_t nspawn_common_container_object_type (filesystem (mount remount relabelto relabelfrom)))

(call nspawn_common_container_template (mycontainer_subject_t mycontainer_object_t))

(allow nspawn_t self (capability (dac_override sys_chroot setpcap setgid setuid mknod
    fsetid sys_admin)))
(allow nspawn_t self (capability (audit_control))) ; FIXME
(allow nspawn_t self (process (getcap setcap setexec)))
(allow nspawn_t self create_netlink_route_socket_perms)
(allow nspawn_t self create_unix_dgram_socket_perms)

(call system_read_kernel_message (nspawn_t))
(call system_read_kernel_sysctl (nspawn_t))
(call system_read_net_proc (nspawn_t))
(call system_request_load_module (nspawn_t))
(call system_setsched (nspawn_t))
(call system_mounton_sysctl_dirs (nspawn_t))
(call system_mounton_kernel_sysctl_files (nspawn_t))
(call system_mounton_kmsg_proc_files (nspawn_t))

(call devices_getattr_random (nspawn_t))
(call devices_getattr_tun_tap (nspawn_t))
(call devices_getattr_urandom (nspawn_t))
(call devices_rw_loop_control (nspawn_t))

(call files_manage_config_lnk_files (nspawn_t))
(call files_mounton_runtime_dirs (nspawn_t))
(call files_read_config_files (nspawn_t)) ; FIXME: /etc/machine-id

(call filesystems_getattr_tmpfs_filesystems (nspawn_t))

(call filesystems_relabelfrom_devpts_filesystems (nspawn_t))

(call filesystems_mount (nspawn_t))

(call filesystems_mprot_write_devtmpfs_dirs (nspawn_t))
(call filesystems_mounton_devtmpfs_dirs (nspawn_t))

(call filesystems_mounton_proc_dirs (nspawn_t))
(call filesystems_mount_proc (nspawn_t))
(call filesystems_remount_proc (nspawn_t))

(call filesystems_mprot_write_rootfs_dirs (nspawn_t))

(call filesystems_manage_cgroup_dirs (nspawn_t))

(call filesystems_relabelfrom_tmpfs_filesystems (nspawn_t))
(call filesystems_mounton_tmpfs_dirs (nspawn_t))
(call filesystems_manage_tmpfs_dirs (nspawn_t))
(call filesystems_manage_tmpfs_lnk_files (nspawn_t))

(call filesystems_mounton_cgroup_dirs (nspawn_t))
(call filesystems_mount_cgroup (nspawn_t))
(call filesystems_remount_cgroup (nspawn_t))

(call filesystems_mounton_rootfs_dirs (nspawn_t))
(call filesystems_mount_tmpfs (nspawn_t))
(call filesystems_remount_tmpfs (nspawn_t))

(call filesystems_mount_sysfs (nspawn_t))
(call filesystems_remount_sysfs (nspawn_t))
(call filesystems_mounton_sysfs_dirs (nspawn_t))

(call filesystems_read_sysfs (nspawn_t))

(call selinux_remount_securityfs (nspawn_t))
(call selinux_validate_context (nspawn_t))

(call storage_rw_fixed_disk (nspawn_t))

(call subject_system_identity_change_exemption (nspawn_t))
(call subject_system_role_change_exemption (nspawn_t))
(call subject_change_exemption (nspawn_t))
(call subject_object_identity_change_exemption (nspawn_t))

(call terminals_create_pty (nspawn_t nspawn_pty_dev_t))

(call dbus_system_client_subject_type (nspawn_t))

(call dns_config_object_type_transition_resolve_config_files (nspawn_t))
(call dns_manage_resolve_config_files (nspawn_t))

(call journal_search_log (nspawn_t))
(call journal_client_subject_type (nspawn_t))

(call machine_manage_lib_files (nspawn_t))
(call machine_read_config_files (nspawn_t))
(call machine_dbus_chat_machined (nspawn_t))

(call miscfiles_read_locale (nspawn_t))

(call nspawn_setattr_terminals (nspawn_t))
(call nspawn_use_terminals (nspawn_t))
(call nspawn_shell_exec_manual_subject_type_transition_all_common_container_subjects (nspawn_t))

(call systemd_search_transient_unit (nspawn_t))
(call systemd_stop_system (nspawn_t))
(call systemd_status_transient_units (nspawn_t))
(call systemd_write_systemd_runtime_sock_files (nspawn_t))

(call udev_read_config_files (nspawn_t))

(call usersubject_search_home_dir (nspawn_t))

(allow nspawn_admin_subject_type nspawn_t (process (ptrace signal signull sigkill sigstop)))
(call ps_subject_pattern (nspawn_admin_subject_type nspawn_t))

(allow nspawn_admin_subject_type nspawn_unit_t (service (all)))

(allow nspawn_admin_subject_type nspawn_object_type (all_file_objects
    (not_mounton_entrypoint_and_execmod)))

(macro nspawn_exec ((type ARG1))
    (call can_exec (ARG1 nspawn_exec_t)))

(macro nspawn_auto_subject_type_transition ((type ARG1))
    (call nspawn_send_signal (ARG1))
    (call auto_subject_type_transition_pattern
        (ARG1 nspawn_exec_t nspawn_t)))

(macro nspawn_send_signal ((type ARG1))
    (allow ARG1 nspawn_t (process (signal))))

(macro nspawn_run ((type ARG1)(role ARG2))
    (call nspawn_auto_subject_type_transition (ARG1))
    (roleattributeset nspawn_role ARG2))

(macro nspawn_search_systemd_runtime ((type ARG1))
    (call systemd_search_runtime (ARG1))
    (allow ARG1 nspawn_systemd_runtime_t search_dir_perms))

(macro nspawn_list_systemd_runtime ((type ARG1))
    (call systemd_search_runtime (ARG1))
    (allow ARG1 nspawn_systemd_runtime_t list_dir_perms))

(macro nspawn_read_systemd_runtime_files ((type ARG1))
    (call systemd_search_runtime (ARG1))
    (call read_files_pattern (ARG1 nspawn_systemd_runtime_t nspawn_systemd_runtime_t)))

(macro nspawn_read_systemd_runtime_lnk_files ((type ARG1))
    (call systemd_search_runtime (ARG1))
    (call read_lnk_files_pattern (ARG1 nspawn_systemd_runtime_t nspawn_systemd_runtime_t)))

(macro nspawn_read_systemd_runtime ((type ARG1))
    (call systemd_search_runtime (ARG1))
    (allow ARG1 nspawn_systemd_runtime_t read_file_perms)
    (allow ARG1 nspawn_systemd_runtime_t list_dir_perms)
    (allow ARG1 nspawn_systemd_runtime_t read_lnk_file_perms))

(macro nspawn_manage_systemd_runtime ((type ARG1))
    (call systemd_rw_runtime_dirs (ARG1))
    (allow ARG1 nspawn_systemd_runtime_t manage_file_perms)
    (allow ARG1 nspawn_systemd_runtime_t manage_dir_perms)
    (allow ARG1 nspawn_systemd_runtime_t manage_lnk_file_perms))

(macro nspawn_systemd_runtime_object_type_transition_runtime_dirs ((type ARG1))
    (call systemd_runtime_object_type_transition (ARG1 nspawn_systemd_runtime_t dir "nspawn")))

(macro nspawn_relabel_terminals ((type ARG1))
    (call filesystems_search_devpts (ARG1))
    (allow ARG1 nspawn_pty_dev_t relabel_chr_file_perms))

(macro nspawn_setattr_terminals ((type ARG1))
    (call filesystems_search_devpts (ARG1))
    (allow ARG1 nspawn_pty_dev_t (chr_file (setattr))))

(macro nspawn_use_terminals ((type ARG1))
    (call filesystems_search_devpts (ARG1))
    (allow ARG1 nspawn_pty_dev_t rw_term_perms))

(macro nspawn_use_inherited_terminals ((type ARG1))
    (allow ARG1 nspawn_pty_dev_t rw_inherited_term_perms))

(macro nspawn_common_container_subject_type ((type ARG1))
    (typeattributeset nspawn_common_container_subject_type ARG1))

(macro nspawn_common_container_object_type ((type ARG1))
    (typeattributeset nspawn_common_container_object_type ARG1))

(macro nspawn_common_container_template ((type ARG1)(type ARG2))
    (call nspawn_common_container_subject_type (ARG1))
    (call nspawn_common_container_object_type (ARG2))
    (allow ARG1 ARG2 (all_file_objects (manage))))

(macro nspawn_shell_exec_manual_subject_type_transition_all_common_container_subjects ((type ARG1))
    (call commands_shell_exec_manual_subject_type_transition (ARG1 nspawn_common_container_subject_type)))

(macro nspawn_read_state ((type ARG1))
    (call filesystems_search_proc (ARG1))
    (allow ARG1 nspawn_t read_file_perms)
    (allow ARG1 nspawn_t list_dir_perms)
    (allow ARG1 nspawn_t read_lnk_file_perms))

(macro nspawn_read_state_all_common_container_subjects ((type ARG1))
    (call filesystems_search_proc (ARG1))
    (allow ARG1 nspawn_common_container_subject_type read_file_perms)
    (allow ARG1 nspawn_common_container_subject_type list_dir_perms)
    (allow ARG1 nspawn_common_container_subject_type read_lnk_file_perms))

(macro nspawn_use_fd ((type ARG1))
    (allow ARG1 nspawn_t (fd (use))))

(macro nspawn_start_unit ((type ARG1))
    (call systemd_search_unit (ARG1))
    (allow ARG1 nspawn_unit_t (service (start))))

(macro nspawn_status_unit ((type ARG1))
    (call systemd_search_unit (ARG1))
    (allow ARG1 nspawn_unit_t (service (status))))

(macro nspawn_stop_unit ((type ARG1))
    (call systemd_search_unit (ARG1))
    (allow ARG1 nspawn_unit_t (service (stop))))

(macro nspawn_admin ((type ARG1))
    (allow ARG1 self (capability (kill sys_ptrace)))
    (typeattributeset nspawn_admin_subject_type ARG1)
    (call systemd_system_service_admin_subject_type (ARG1)))
